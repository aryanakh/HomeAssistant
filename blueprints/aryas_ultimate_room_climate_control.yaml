blueprint:
  name: Arya's Ultimate Room Climate Control
  author: AryaNakh
  homeassistant:
    min_version: 2023.1.0
  description: >
    This blueprint turns your central thermostat into a "room-first" climate controller.
    It ignores the thermostat's built-in sensor and uses a real room sensor to keep that specific room in your desired temperature range.
    
    How it works:
    • If the room is too hot → lowers the thermostat setpoint to force more cooling
    • If the room is too cold → raises the thermostat setpoint to force more heating
    • If the room is perfect → sets a comfortable range (target_temp_low / high) in heat_cool or auto mode — or a neutral single setpoint otherwise

  domain: automation
  input:
    thermostat:
      name: Main Thermostat
      description: Your main climate entity (e.g. climate.upstairs_thermostat)
      selector:
        entity:
          domain: climate

    room_sensor:
      name: Room Temperature Sensor
      description: The sensor in the room you care about (e.g. sensor.nursery_temperature)
      selector:
        entity:
          domain: sensor
          device_class: temperature

    min_temperature:
      name: Minimum Desired Temperature
      description: Lowest temperature the room should be (e.g. 68 °F)
      selector:
        number:
          min: 55
          max: 80
          step: 0.5
          unit_of_measurement: "°F"
      default: 68

    max_temperature:
      name: Maximum Desired Temperature
      description: Highest temperature the room should be (e.g. 70 °F)
      selector:
        number:
          min: 55
          max: 80
          step: 0.5
          unit_of_measurement: "°F"
      default: 70

    control_mode:
      name: Control HVAC Mode
      description: Mode for active control (forcing heat/cool). Neutral state uses range if heat_cool/auto.
      selector:
        select:
          options:
            - heat_cool
            - auto
            - heat
            - cool
          sort: false
      default: heat_cool

    check_every_minutes:
      name: Check Frequency
      description: How often to check/adjust (minutes). Default is 10 minutes to not overwhelm the Climate control unit. 
      selector:
        number:
          min: 1
          max: 30
          step: 1
          unit_of_measurement: minutes
      default: 10

variables:
  thermostat: !input thermostat
  room_sensor: !input room_sensor
  min_temp: !input min_temperature
  max_temp: !input max_temperature
  target_temp: "{{ ((min_temp + max_temp) / 2) | float }}"
  control_mode: !input control_mode
  use_range_mode: "{{ control_mode in ['heat_cool', 'auto'] }}"
  interval_min: "{{ check_every_minutes | int(10) }}"

trigger:
  # Trigger 1: Any change in room temperature (we'll filter meaningful changes in template)
  - platform: state
    entity_id: !input room_sensor

  # Trigger 2: Periodic check every N minutes using modulo
  - platform: template
    value_template: >-
      {{ now().minute % interval_min == 0 }}
    for:
      seconds: 10

condition:
  - condition: template
    value_template: >-
      {{ is_number(states(room_sensor)) and 
         states(thermostat) in ['heat', 'cool', 'heat_cool', 'auto'] }}

action:
  - variables:
      room_temp: "{{ states(room_sensor) | float(0) }}"
      current_temp: "{{ state_attr(thermostat, 'temperature') | float(none) }}"
      current_low: "{{ state_attr(thermostat, 'target_temp_low') | float(none) }}"
      current_high: "{{ state_attr(thermostat, 'target_temp_high') | float(none) }}"
      desired_setpoint: "{{ (2 * target_temp - room_temp) | round(1) }}"

  # Only proceed if change is meaningful (≥1°F) OR it's a periodic check OR room is out of range
  - condition: or
    conditions:
      # Meaningful change from state trigger
      - condition: template
        value_template: >-
          {% if trigger.platform == 'state' %}
            {{ trigger.from_state is not none and trigger.to_state is not none and
               (trigger.to_state.state | float(0) - trigger.from_state.state | float(0)) | abs >= 1 }}
          {% else %}
            true  # always allow periodic triggers
          {% endif %}
      # Room out of range (safety net)
      - "{{ room_temp < min_temp or room_temp > max_temp }}"

  # Rest of action (adjustment logic) unchanged
  - condition: or
    conditions:
      - "{{ room_temp < min_temp or room_temp > max_temp }}"
      - condition: template
        value_template: >-
          {% if use_range_mode %}
            {{ current_low is none or current_high is none 
               or current_low | round(1) != min_temp | round(1)
               or current_high | round(1) != max_temp | round(1) }}
          {% else %}
            {{ current_temp is none or (desired_setpoint - current_temp) | abs > 0.8 }}
          {% endif %}

  - choose:
      - conditions:
          - "{{ room_temp < min_temp }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input thermostat
            data:
              hvac_mode: heat
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: "{{ desired_setpoint }}"

      - conditions:
          - "{{ room_temp > max_temp }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input thermostat
            data:
              hvac_mode: cool
          - service: climate.set_temperature
            target:
              entity_id: !input thermostat
            data:
              temperature: "{{ desired_setpoint }}"

      - conditions: []
        sequence:
          - choose:
              - conditions:
                  - "{{ use_range_mode }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input thermostat
                    data:
                      hvac_mode: !input control_mode
                  - service: climate.set_temperature
                    target:
                      entity_id: !input thermostat
                    data:
                      target_temp_low: "{{ min_temp | round(1) }}"
                      target_temp_high: "{{ max_temp | round(1) }}"

              - conditions: []
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input thermostat
                    data:
                      hvac_mode: !input control_mode
                  - service: climate.set_temperature
                    target:
                      entity_id: !input thermostat
                    data:
                      temperature: "{{ target_temp | round(1) }}"

mode: single
